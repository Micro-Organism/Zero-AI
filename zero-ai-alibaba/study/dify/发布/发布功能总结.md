# Dify 发布功能总结

## 一、发布方式概览

Dify 提供四种主要的发布方式，每种方式适用于不同的使用场景：

| 发布方式 | 特点 | 适用场景 | 文档位置 |
|---------|------|---------|---------|
| **Web 应用** | 即时、可分享的应用 | 测试想法或直接为最终用户提供服务 | [WebApp文档](./webapp/) |
| **API 集成** | 将 AI 嵌入到现有产品 | 完全控制用户体验和数据流 | [API集成文档](./Dify-API集成学习.md) |
| **网站嵌入** | 向网站添加聊天组件 | 客户支持或潜在客户筛选 | [网站嵌入文档](./webapp/网站嵌入.md) |
| **MCP 服务器** | 连接到 AI 工具 | 开发工作流 | [MCP服务器文档](./MCP服务器.md) |

## 二、如何获取应用ID（appId）

### 2.1 在 Dify 界面中获取

1. **登录 Dify**：访问你的 Dify 实例（例如：http://10.133.0.147:18082）
2. **进入应用列表**：点击左侧导航栏的"工作室"或"应用"
3. **选择应用**：点击你想要使用的应用
4. **查看应用ID**：
   - 方法1：在浏览器地址栏中查看 URL，格式为：`/app/{appId}/develop`
     - 例如：`http://10.133.0.147:18082/app/c46e6278-529e-4baf-9689-82e36f71ccfd/develop`
     - 应用ID就是：`c46e6278-529e-4baf-9689-82e36f71ccfd`
   - 方法2：在应用的"发布"或"API Access"页面查看
   - 方法3：在应用设置中查看应用详情

### 2.2 通过 API 获取应用列表

如果你有 Dify 的管理权限，可以通过 Console API 获取应用列表：

```bash
GET /console/api/apps?page=1&limit=30
```

响应中会包含每个应用的 `id` 字段，这就是 `appId`。

### 2.3 应用ID格式

- Dify 的应用ID通常是 UUID 格式
- 例如：`c46e6278-529e-4baf-9689-82e36f71ccfd`
- 长度通常为 36 个字符（包含连字符）

## 三、如何获取 API Key

### 3.1 在 Dify 界面中获取

1. **进入应用**：选择你要使用的应用
2. **打开 API 设置**：点击左侧边栏的"发布"或"API Access"
3. **创建 API 凭据**：
   - 点击"创建 API Key"或"生成新密钥"
   - 为你的集成生成新凭据
   - 你可以为不同环境或用户创建多个密钥
4. **复制密钥**：创建后立即复制并保存，因为之后无法再次查看完整密钥

### 3.2 API Key 格式

- Dify 的 API Key 通常以 `app-` 开头
- 例如：`app-xxxxxxxxxxxxxxxxxxxxx`
- 长度通常为 30-40 个字符

### 3.3 安全注意事项

- **永远不要在前端代码或客户端请求中暴露 API 密钥**
- **始终从后端调用 Dify API** 以防止滥用并维护安全性
- **在后端将 API 密钥存储为环境变量**
- **定期轮换密钥并撤销未使用的凭据**

## 四、如何获取工具列表

### 4.1 重要发现

根据学习 Dify API 文档，我们发现：

1. **Dify 没有全局工具列表接口**：不存在 `/v1/tools` 这样的接口
2. **工具信息是应用级别的**：必须提供 `appId` 才能获取工具列表
3. **工具配置在应用详情中**：需要通过应用详情接口获取

### 4.2 获取工具列表的正确方式

#### 方式1：通过 Console API（推荐）

```bash
GET /console/api/apps/{appId}
```

响应中可能包含工具配置的字段：
- `tool_configurations`
- `model_config.tools`
- `agent_config.tools`
- `tools`

#### 方式2：通过 V1 API

```bash
GET /v1/apps/{appId}
```

注意：V1 API 可能返回的信息不如 Console API 完整。

### 4.3 工具配置位置

工具配置可能位于应用详情的以下字段中：

1. **tool_configurations**：工具配置列表
2. **model_config.tools**：模型配置中的工具列表
3. **agent_config.tools**：Agent配置中的工具列表（对于Agent类型应用）
4. **tools**：直接的工具列表

### 4.4 工具配置格式

工具配置可能有多种格式：

```json
{
  "tool_configurations": [
    {
      "id": "tool-id",
      "tool": {
        "identity": {
          "name": "tool-name"
        },
        "name": "Tool Name",
        "description": "Tool description"
      },
      "parameters": {}
    }
  ]
}
```

## 五、代码实现建议

### 5.1 获取工具列表

```java
// 必须提供 appId
if (appId == null || appId.isEmpty()) {
    // 返回错误，提示用户提供 appId
    return errorResponse("需要提供 appId 参数");
}

// 优先使用 Console API
String url = difyApiUrl + "/console/api/apps/" + appId;

// 递归搜索工具配置
List<Map<String, Object>> tools = findToolsInMap(response);
```

### 5.2 错误处理

- 当没有提供 `appId` 时，返回明确的错误提示
- 当应用不存在时，返回友好的错误信息
- 当工具列表为空时，提示用户检查应用配置

### 5.3 日志记录

- 记录完整的 API 响应结构，便于调试
- 记录找到工具的位置和数量
- 记录错误信息，便于排查问题

## 六、配置参数说明

### 6.1 必需参数

- **appId**：应用ID，必须提供
- **API Key 或用户名/密码**：用于身份验证

### 6.2 可选参数

- **difyApiUrl**：Dify API 基础URL（默认：http://10.133.0.147:18082）
- **difyApiKey**：API 密钥（如果使用 API Key 认证）
- **difyUsername**：用户名（如果使用 Basic 认证）
- **difyPassword**：密码（如果使用 Basic 认证）

### 6.3 环境变量配置

建议在 `.env` 文件中配置：

```properties
dify.api.url=http://10.133.0.147:18082
dify.api.key=app-xxxxxxxxxxxxxxxxxxxxx
# 或者使用用户名密码
dify.api.username=your-username
dify.api.password=your-password
```

## 七、常见问题

### 7.1 为什么获取工具列表返回空？

可能的原因：
1. **没有提供 appId**：必须提供应用ID
2. **应用不存在**：检查应用ID是否正确
3. **应用没有配置工具**：在 Dify 中检查应用的工具配置
4. **权限问题**：检查 API Key 或用户权限是否足够
5. **字段路径不正确**：工具配置可能在不同的字段中

### 7.2 如何验证 appId 是否正确？

1. 在浏览器中访问：`http://10.133.0.147:18082/app/{appId}/develop`
2. 如果页面正常加载，说明 appId 正确
3. 如果返回 404，说明 appId 不存在

### 7.3 如何验证 API Key 是否正确？

1. 使用 API Key 调用一个简单的 API（如获取应用详情）
2. 如果返回 401 或 403，说明 API Key 无效或权限不足
3. 如果返回正常数据，说明 API Key 有效

## 八、最佳实践

1. **始终提供 appId**：工具列表是应用级别的，必须提供 appId
2. **使用 Console API**：Console API 返回更完整的应用配置
3. **递归搜索工具**：工具配置可能嵌套在不同字段中
4. **统一格式化**：将不同格式的工具配置统一为标准格式
5. **详细日志**：记录关键信息，便于调试和排查问题
6. **错误处理**：提供友好的错误提示，帮助用户理解问题

## 九、总结

1. **Dify 没有全局工具列表接口**，必须通过应用详情获取
2. **必须提供 appId**，可以从浏览器 URL 或应用设置中获取
3. **工具配置可能在不同字段中**，需要递归搜索
4. **使用 Console API** 获取更完整的应用配置
5. **安全第一**：妥善保管 API Key，不要在前端暴露

